<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" th:href="@{images/favicon.jpg}" type="image/svg+xml">
    <title>Detalle del Pedido - Enviart</title>
    <meta name="description" content="Consulta los detalles completos de tu pedido de envío">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <!-- Tracking CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" th:href="@{/css/tracking.css}">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
        }

        .timeline-item {
            position: relative;
            padding-left: 40px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 12px;
            top: 30px;
            bottom: -20px;
            width: 2px;
            background: #e5e7eb;
        }

        .timeline-item:last-child::before {
            display: none;
        }

        .timeline-dot {
            position: absolute;
            left: 0;
            top: 8px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen">

    <!-- Navbar -->
    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="bg-gradient-to-br from-purple-600 to-indigo-600 text-white p-2 rounded-lg">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                        </svg>
                    </div>
                    <span class="text-xl font-bold text-slate-800">Enviart</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-slate-600" th:text="${email}">usuario@enviart.com</span>
                    <a th:href="@{/pedidos}" class="text-purple-600 hover:text-purple-700 font-semibold text-sm">
                        ← Volver a Pedidos
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12">

        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h1 class="text-3xl font-extrabold text-slate-800 mb-2">
                        Pedido #<span th:text="${pedido.idPedido}">1234</span>
                    </h1>
                    <p class="text-sm text-slate-500">
                        Creado el <span
                            th:text="${#temporals.format(pedido.fechaPedido, 'dd/MM/yyyy')}">27/11/2025</span>
                        a las <span th:text="${#temporals.format(pedido.fechaPedido, 'HH:mm')}">10:30</span>
                    </p>
                </div>
                <div>
                    <span th:class="${pedido.estado.nombre == 'RECEPCIONADO' ? 'bg-yellow-100 text-yellow-700' : 
                                    pedido.estado.nombre == 'EN_TRANSITO' ? 'bg-blue-100 text-blue-700' : 
                                    pedido.estado.nombre == 'EN_DISTRIBUCION' ? 'bg-indigo-100 text-indigo-700' : 
                                    pedido.estado.nombre == 'ENTREGADO' ? 'bg-green-100 text-green-700' : 
                                    pedido.estado.nombre == 'DEVUELTO' ? 'bg-red-100 text-red-700' : 
                                    'bg-gray-100 text-gray-700'}" class="px-3 py-1 text-sm font-medium rounded-full">
                        <span th:text="${pedido.estado.nombre}">RECEPCIONADO</span>
                    </span>
                </div>
            </div>

            <!-- Total -->
            <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl p-6 border-2 border-purple-200">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-sm font-semibold text-slate-600 mb-1">Total del Pedido</p>
                        <p class="text-4xl font-extrabold text-purple-600">
                            $<span th:text="${#numbers.formatDecimal(pedido.totalFinal, 1, 2)}">125.50</span>
                        </p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-semibold text-slate-600 mb-1">Número de Paquetes</p>
                        <p class="text-3xl font-bold text-slate-800" th:text="${paquetes.size()}">1</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Direcciones -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- Origen -->
            <div class="bg-white rounded-2xl shadow-xl p-6">
                <div class="flex items-center gap-3 mb-4">
                    <div class="bg-blue-100 p-3 rounded-xl">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </div>
                    <h2 class="text-xl font-bold text-slate-800">Dirección de Origen</h2>
                </div>
                <div class="space-y-2">
                    <p class="text-lg font-semibold text-slate-800" th:text="${pedido.direccionOrigen.nombreContacto}">
                        Juan Pérez</p>
                    <p class="text-sm text-slate-600"
                        th:text="${pedido.direccionOrigen.calle + ' ' + pedido.direccionOrigen.numero}">Calle 45 #23-67
                    </p>
                    <p class="text-sm text-slate-600">CP: <span
                            th:text="${pedido.direccionOrigen.codigoPostal}">11001</span></p>
                    <p class="text-sm text-slate-600 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                        </svg>
                        <span th:text="${pedido.direccionOrigen.telefonoContacto}">3001234567</span>
                    </p>
                </div>
            </div>

            <!-- Destino -->
            <div class="bg-white rounded-2xl shadow-xl p-6">
                <div class="flex items-center gap-3 mb-4">
                    <div class="bg-green-100 p-3 rounded-xl">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                        </svg>
                    </div>
                    <h2 class="text-xl font-bold text-slate-800">Dirección de Destino</h2>
                </div>
                <div class="space-y-2">
                    <p class="text-lg font-semibold text-slate-800" th:text="${pedido.direccionDestino.nombreContacto}">
                        María García</p>
                    <p class="text-sm text-slate-600"
                        th:text="${pedido.direccionDestino.calle + ' ' + pedido.direccionDestino.numero}">Av. Caracas
                        #78-12</p>
                    <p class="text-sm text-slate-600">CP: <span
                            th:text="${pedido.direccionDestino.codigoPostal}">11021</span></p>
                    <p class="text-sm text-slate-600 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                        </svg>
                        <span th:text="${pedido.direccionDestino.telefonoContacto}">3109876543</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Tracking en Tiempo Real -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-6" id="trackingSection">
            <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-3">
                <div class="bg-blue-100 p-3 rounded-xl">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </div>
                Seguimiento en Tiempo Real
            </h2>

            <div class="tracking-card">
                <div class="tracking-info">
                    <div class="tracking-info-item">
                        <label>Estado</label>
                        <div class="value">
                            <span id="trackingEstado" class="tracking-status" th:text="${pedido.estado.nombre}">-</span>
                        </div>
                    </div>
                    <div class="tracking-info-item">
                        <label>Velocidad</label>
                        <div class="value" id="trackingVelocidad">- km/h</div>
                    </div>
                    <div class="tracking-info-item">
                        <label>Última Actualización</label>
                        <div class="value" id="trackingUltimaActualizacion">-</div>
                    </div>
                </div>

                <div id="trackingMap" class="tracking-map-container"
                    style="height: 400px; width: 100%; border-radius: 0.5rem;"></div>

                <div id="wsStatus" class="ws-status connecting mt-4">
                    <span class="ws-status-dot"></span>
                    <span id="wsStatusText">Conectando servicio de ubicación...</span>
                </div>
            </div>
        </div>

        <!-- Paquetes -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
            <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-3">
                <div class="bg-purple-100 p-3 rounded-xl">
                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                    </svg>
                </div>
                Detalles de Paquetes
            </h2>

            <div class="space-y-4">
                <div th:each="paquete, iterStat : ${paquetes}"
                    class="border-2 border-purple-200 rounded-xl p-6 bg-gradient-to-r from-purple-50 to-indigo-50">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-lg font-bold text-slate-800">
                            Paquete #<span th:text="${iterStat.count}">1</span>
                        </h3>
                        <span class="bg-purple-600 text-white px-4 py-2 rounded-lg font-bold">
                            $<span th:text="${#numbers.formatDecimal(paquete.costoServicio, 1, 2)}">45.50</span>
                        </span>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <p class="text-xs font-semibold text-slate-500 mb-1">Tipo de Servicio</p>
                            <p class="text-sm font-bold text-slate-800" th:text="${paquete.tipoServicio.nombre}">
                                Estándar</p>
                        </div>
                        <div>
                            <p class="text-xs font-semibold text-slate-500 mb-1">Peso</p>
                            <p class="text-sm font-bold text-slate-800">
                                <span th:text="${#numbers.formatDecimal(paquete.pesoKg, 1, 2)}">5.5</span> kg
                            </p>
                        </div>
                        <div>
                            <p class="text-xs font-semibold text-slate-500 mb-1">Dimensiones (cm)</p>
                            <p class="text-sm font-bold text-slate-800">
                                <span th:text="${#numbers.formatDecimal(paquete.largoCm, 1, 0)}">50</span> x
                                <span th:text="${#numbers.formatDecimal(paquete.anchoCm, 1, 0)}">40</span> x
                                <span th:text="${#numbers.formatDecimal(paquete.altoCm, 1, 0)}">30</span>
                            </p>
                        </div>
                        <div th:if="${paquete.valorDeclarado != null}">
                            <p class="text-xs font-semibold text-slate-500 mb-1">Valor Declarado</p>
                            <p class="text-sm font-bold text-slate-800">
                                $<span th:text="${#numbers.formatDecimal(paquete.valorDeclarado, 1, 2)}">1000.00</span>
                            </p>
                        </div>
                    </div>

                    <div th:if="${paquete.descripcionContenido != null and !paquete.descripcionContenido.isEmpty()}">
                        <p class="text-xs font-semibold text-slate-500 mb-1">Descripción del Contenido</p>
                        <p class="text-sm text-slate-700" th:text="${paquete.descripcionContenido}">Documentos
                            importantes</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Timeline de Estado (Mock - puedes conectarlo con datos reales) -->
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-3">
                <div class="bg-indigo-100 p-3 rounded-xl">
                    <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                Historial de Estado
            </h2>

            <div class="space-y-6">
                <div class="timeline-item">
                    <div class="timeline-dot bg-green-500">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7">
                            </path>
                        </svg>
                    </div>
                    <div>
                        <p class="font-bold text-slate-800">Pedido Creado</p>
                        <p class="text-sm text-slate-500"
                            th:text="${#temporals.format(pedido.fechaPedido, 'dd/MM/yyyy HH:mm')}">27/11/2025 10:30</p>
                    </div>
                </div>

                <div class="timeline-item" th:if="${pedido.estado.nombre != 'RECEPCIONADO'}">
                    <div class="timeline-dot bg-blue-500">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7">
                            </path>
                        </svg>
                    </div>
                    <div>
                        <p class="font-bold text-slate-800">En Tránsito</p>
                        <p class="text-sm text-slate-500">El pedido está en camino</p>
                    </div>
                </div>

                <div class="timeline-item opacity-50" th:if="${pedido.estado.nombre == 'RECEPCIONADO'}">
                    <div class="timeline-dot bg-slate-300">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div>
                        <p class="font-bold text-slate-500">En Tránsito</p>
                        <p class="text-sm text-slate-400">Pendiente de envío</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Tracking Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script th:src="@{/js/tracking-client.js}"></script>
    <script th:src="@{/js/tracking-map.js}"></script>

    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', () => {
            const pedidoId = [[${ pedido.idPedido }]];
            console.log('Iniciando tracking para pedido:', pedidoId);
            const trackingMap = new TrackingMap('trackingMap', pedidoId);

            // Expose for debugging
            window.trackingMap = trackingMap;
        });
    </script>
</body>

</html>